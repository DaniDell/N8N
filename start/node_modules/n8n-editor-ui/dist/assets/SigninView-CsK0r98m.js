import{L as A,A as V}from"./AuthView-Bpw90ooz.js";import{u as T,cT as I,a as _,M as E,cU as v,R as B,i as N,b as L,V as D,cV as U}from"./index-DEwaaDne.js";import{m as R}from"./pinia-BAhPp3pQ.js";import{G as $,l as i,m as k,p as s,U as m,I as a,O as f,S as g,T as c,M as u,R as n,ag as r}from"./vendor-Dv5OeN6t.js";import{_ as F}from"./n8n-B6cfQsVX.js";import"./axios-Mm4CS0gO.js";import"./flatted-DN8lQ2XG.js";import"./@vueuse/core-9E8Shwsg.js";import"./lodash-es-BxV-E8rt.js";import"./@n8n/permissions-BxxteU-C.js";import"./dateformat-B9ocXky7.js";import"./vue-i18n-Delvyc9x.js";import"./uuid-SoommWqA.js";import"./luxon-CLwAIbs0.js";import"./@n8n/codemirror-lang-sql-x14jMqbG.js";import"./@lezer/common-B6ct0j_v.js";import"./prettier-bS6l4Vb1.js";import"./@jsplumb/util-DS-9vq_E.js";import"./@jsplumb/core-CVBraiyY.js";import"./@jsplumb/common-CF-b-6-M.js";import"./@jsplumb/connector-bezier-BGU0Ovbw.js";import"./@jsplumb/browser-ui-BVF2KoJK.js";import"./codemirror-lang-html-n8n-DcTmlMkf.js";import"./@n8n/codemirror-lang-Qkdx7NoQ.js";import"./esprima-next-nhoSXAeq.js";import"./fast-json-stable-stringify-LluJPcs3.js";import"./timeago.js-CiyKClrF.js";import"./qrcode.vue-BGkPba5A.js";import"./vue3-touch-events-mV0oX_Sl.js";import"./chart.js-343vZi4M.js";const h={MFA_TOKEN:"MFA_TOKEN",MFA_RECOVERY_CODE:"MFA_RECOVERY_CODE"},P=$({name:"MfaView",components:{Logo:A},props:{reportError:Boolean},setup(){return{...T()}},data(){return{hasAnyChanges:!1,formBus:I,formInputs:null,showRecoveryCodeForm:!1,verifyingMfaToken:!1,formError:""}},async mounted(){this.formInputs=[this.mfaTokenFieldWithDefaults()]},computed:{...R(_)},methods:{onRecoveryCodeClick(){this.formError="",this.showRecoveryCodeForm=!0,this.hasAnyChanges=!1,this.formInputs=[this.mfaRecoveryCodeFieldWithDefaults()],this.$emit("onFormChanged",h.MFA_RECOVERY_CODE)},onBackClick(){if(!this.showRecoveryCodeForm){this.$emit("onBackClick",h.MFA_TOKEN);return}this.showRecoveryCodeForm=!1,this.hasAnyChanges=!0,this.formInputs=[this.mfaTokenFieldWithDefaults()],this.$emit("onBackClick",h.MFA_RECOVERY_CODE)},onInput({target:{value:e,name:o}}){const t=o==="token",l=t?E:v;if(e.length!==l){this.hasAnyChanges=!1;return}this.verifyingMfaToken=!0,this.hasAnyChanges=!0;const d=t?{token:e,recoveryCode:""}:{token:"",recoveryCode:e};this.onSubmit(d).catch(()=>{}).finally(()=>this.verifyingMfaToken=!1)},async onSubmit(e){this.formError=this.showRecoveryCodeForm?this.$locale.baseText("mfa.recovery.invalid"):this.$locale.baseText("mfa.code.invalid"),this.$emit("submit",e)},onSaveClick(){this.formBus.emit("submit")},mfaTokenFieldWithDefaults(){return this.formField("token",this.$locale.baseText("mfa.code.input.label"),this.$locale.baseText("mfa.code.input.placeholder"),E)},mfaRecoveryCodeFieldWithDefaults(){return this.formField("recoveryCode",this.$locale.baseText("mfa.recovery.input.label"),this.$locale.baseText("mfa.recovery.input.placeholder"),v)},formField(e,o,t,l,d=!0){return{name:e,initialValue:"",properties:{label:o,placeholder:t,maxlength:l,capitalize:!0,validateOnBlur:!1,focusInitially:d}}}}}),W="_container_1mdjt_5",z="_logoContainer_1mdjt_16",j="_formContainer_1mdjt_21",G="_headerContainer_1mdjt_25",H="_formError_1mdjt_30",q="_recoveryCodeLink_1mdjt_34",Y="_infoBox_1mdjt_38",K={container:W,logoContainer:z,formContainer:j,headerContainer:G,formError:H,recoveryCodeLink:q,infoBox:Y};function Q(e,o,t,l,d,M){const p=r("Logo"),C=r("n8n-heading"),O=r("n8n-form-inputs"),b=r("n8n-text"),w=r("n8n-button"),S=r("n8n-card");return i(),k("div",{class:a(e.$style.container)},[s("div",{class:a(e.$style.logoContainer)},[m(p)],2),m(S,null,{default:f(()=>[s("div",{class:a(e.$style.headerContainer)},[m(C,{size:"xlarge",color:"text-dark"},{default:f(()=>[g(c(e.showRecoveryCodeForm?e.$locale.baseText("mfa.recovery.modal.title"):e.$locale.baseText("mfa.code.modal.title")),1)]),_:1})],2),s("div",{class:a([e.$style.formContainer,e.reportError?e.$style.formError:""])},[e.formInputs?(i(),u(O,{key:0,"data-test-id":"mfa-login-form",inputs:e.formInputs,"event-bus":e.formBus,onInput:e.onInput,onSubmit:e.onSubmit},null,8,["inputs","event-bus","onInput","onSubmit"])):n("",!0),s("div",{class:a(e.$style.infoBox)},[!e.showRecoveryCodeForm&&!e.reportError?(i(),u(b,{key:0,size:"small",color:"text-base",bold:!1},{default:f(()=>[g(c(e.$locale.baseText("mfa.code.input.info"))+" ",1),s("a",{"data-test-id":"mfa-enter-recovery-code-button",onClick:o[0]||(o[0]=(...y)=>e.onRecoveryCodeClick&&e.onRecoveryCodeClick(...y))},c(e.$locale.baseText("mfa.code.input.info.action")),1)]),_:1})):n("",!0),e.reportError?(i(),u(b,{key:1,color:"danger",size:"small"},{default:f(()=>[g(c(e.formError)+" ",1),e.showRecoveryCodeForm?n("",!0):(i(),k("a",{key:0,class:a(e.$style.recoveryCodeLink),onClick:o[1]||(o[1]=(...y)=>e.onRecoveryCodeClick&&e.onRecoveryCodeClick(...y))},c(e.$locale.baseText("mfa.recovery.input.info.action")),3))]),_:1})):n("",!0)],2)],2),s("div",null,[m(w,{float:"right",loading:e.verifyingMfaToken,label:e.showRecoveryCodeForm?e.$locale.baseText("mfa.recovery.button.verify"):e.$locale.baseText("mfa.code.button.continue"),size:"large",disabled:!e.hasAnyChanges,onClick:e.onSaveClick},null,8,["loading","label","disabled","onClick"]),m(w,{float:"left",label:e.$locale.baseText("mfa.button.back"),size:"large",type:"tertiary",onClick:e.onBackClick},null,8,["label","onClick"])])]),_:1})],2)}const X={$style:K},J=F(P,[["render",Q],["__cssModules",X]]),Z=$({name:"SigninView",components:{AuthView:V,MfaView:J},setup(){return{...T()}},data(){return{FORM_CONFIG:{},loading:!1,showMfaView:!1,email:"",password:"",reportError:!1}},computed:{...R(_,L,N,B),userHasMfaEnabled(){var e;return!!((e=this.usersStore.currentUser)!=null&&e.mfaEnabled)}},mounted(){let e=this.$locale.baseText("auth.email");const o=this.settingsStore.ldapLoginLabel,t=this.settingsStore.isLdapLoginEnabled;t&&o&&(e=o),this.FORM_CONFIG={title:this.$locale.baseText("auth.signin"),buttonText:this.$locale.baseText("auth.signin"),redirectText:this.$locale.baseText("forgotPassword"),inputs:[{name:"email",properties:{label:e,type:"email",required:!0,...!t&&{validationRules:[{name:"VALID_EMAIL"}]},showRequiredAsterisk:!1,validateOnBlur:!1,autocomplete:"email",capitalize:!0}},{name:"password",properties:{label:this.$locale.baseText("auth.password"),type:"password",required:!0,showRequiredAsterisk:!1,validateOnBlur:!1,autocomplete:"current-password",capitalize:!0}}]},this.settingsStore.isDesktopDeployment||(this.FORM_CONFIG.redirectLink="/forgot-password")},methods:{async onMFASubmitted(e){await this.login({email:this.email,password:this.password,token:e.token,recoveryCode:e.recoveryCode})},async onEmailPasswordSubmitted(e){await this.login(e)},isRedirectSafe(){const e=this.getRedirectQueryParameter();return e.startsWith("/")||e.startsWith(window.location.origin)},getRedirectQueryParameter(){var o,t;let e="";return typeof((o=this.$route.query)==null?void 0:o.redirect)=="string"&&(e=decodeURIComponent((t=this.$route.query)==null?void 0:t.redirect)),e},async login(e){try{if(this.loading=!0,await this.usersStore.loginWithCreds({email:e.email,password:e.password,mfaToken:e.token,mfaRecoveryCode:e.recoveryCode}),this.loading=!1,this.settingsStore.isCloudDeployment)try{await this.cloudPlanStore.checkForCloudPlanData()}catch(o){console.warn("Failed to check for cloud plan data",o)}if(await this.settingsStore.getSettings(),this.clearAllStickyNotifications(),this.$telemetry.track("User attempted to login",{result:this.showMfaView?"mfa_success":"success"}),this.isRedirectSafe()){const o=this.getRedirectQueryParameter();if(o.startsWith("http")){window.location.href=o;return}this.$router.push(o);return}await this.$router.push({name:D.HOMEPAGE})}catch(o){if(o.errorCode===U){this.showMfaView=!0,this.cacheCredentials(e);return}if(this.$telemetry.track("User attempted to login",{result:this.showMfaView?"mfa_token_rejected":"credentials_error"}),!this.showMfaView){this.showError(o,this.$locale.baseText("auth.signin.error")),this.loading=!1;return}this.reportError=!0}},onBackClick(e){this.reportError=!1,e===h.MFA_TOKEN&&(this.showMfaView=!1,this.loading=!1)},onFormChanged(e){e===h.MFA_RECOVERY_CODE&&(this.reportError=!1)},cacheCredentials(e){this.email=e.email,this.password=e.password}}});function x(e,o,t,l,d,M){const p=r("AuthView"),C=r("MfaView");return i(),k("div",null,[e.showMfaView?n("",!0):(i(),u(p,{key:0,form:e.FORM_CONFIG,"form-loading":e.loading,"with-sso":!0,"data-test-id":"signin-form",onSubmit:e.onEmailPasswordSubmitted},null,8,["form","form-loading","onSubmit"])),e.showMfaView?(i(),u(C,{key:1,"report-error":e.reportError,onSubmit:e.onMFASubmitted,onOnBackClick:e.onBackClick,onOnFormChanged:e.onFormChanged},null,8,["report-error","onSubmit","onOnBackClick","onOnFormChanged"])):n("",!0)])}const Oe=F(Z,[["render",x]]);export{Oe as default};
//# sourceMappingURL=SigninView-CsK0r98m.js.map
